<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>Upload File</title>
    <style>
        .message {
            margin: 3px 0;
            padding: 5px;
            border-radius: 3px;
            display: block;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .tooltip {
          position: absolute;
          background-color: #333;
          color: white;
          padding: 10px;
          border-radius: 5px;
          z-index: 1000;
        }
    </style>
</head>
<body>
    <form action="/upload" method="post" enctype="multipart/form-data">
        <label for="user_id">User ID:</label>
        <input type="text" id="user_id" name="user_id" required><br><br>
        <label for="file">选择文件</label>
        <input type="file" id="file" name="file" required><br><br>
        <input type="submit" value="上传">
    </form>
    <!--<div id="test"></div>-->
    <div id="queue-status" style="margin-top: 20px; color: blue;"></div>
    <div id="messages-container" style="margin-top: 20px;"></div>
    <div id="progress" style="margin-top: 20px;"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
const socket = io();

document.querySelector('form').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // 追加消息到消息容器
        appendMessage(data.message, data.success ? 'success' : 'error');
    })
    .catch(error => {
        document.getElementById('message').innerText = '发生错误：' + error;
        // 追加消息到消息容器
        appendMessage('发生错误：' + error, 'error');
    });
});

socket.on('connect', () => {
    console.log('Connected to server');
    // 追加连接成功的消息
    appendMessage('已连接到服务器', 'info');
});

socket.on('progress', (data) => {
    if (document.getElementById('user_id').value === data.user_id) {
        // 追加进度消息
        appendMessage(data.message, 'info');
    }
});

socket.on('error', (data) => {
    if (document.getElementById('user_id').value === data.user_id) {
        // 追加错误消息
        appendMessage(data.message, 'error');
    }
});

socket.on('queue_status', (data) => {
    if (document.getElementById('user_id').value === data.user_id) {
        // 追加队列状态消息
        appendMessage(data.message, 'info');
    }
});

socket.on('url', (data) => {
    if (document.getElementById('user_id').value === data.user_id) {
        download(data.url);
    }
})

socket.on('fprogress', (data) => {
    if (document.getElementById('user_id').value === data.user_id) {
        appendFileMessage(appendMessage("OCR日志", 'info')).innerText = data.message;
        appendFileMessage(appendMessage("OCR报错", 'error')).innerText = data.error;
    }
});

//<div id="tooltip" class="tooltip" style="display: none;">这是浮动窗口内容</div>
function appendFileMessage(input) {
    const errorMessage = document.createElement('a')
    //const input = input;
    errorMessage.id = "tooltip";
    errorMessage.className = "tooltip";
    errorMessage.style.display = "none";

    input.appendChild(errorMessage);

    input.addEventListener('mouseover', function() {
        errorMessage.style.display = 'block';
        //errorMessage.style.left = input.pageX + 1000 + 'px';
    });

    input.addEventListener('mouseout', function() {
        errorMessage.style.display = 'none';
    });

    return errorMessage;
}

function download(url) {
    const a = document.createElement('a');
    a.href = url;
    a.innerText = '若浏览器未下载，点击此链接';
    document.getElementById('messages-container').appendChild(a);
    a.click();
}

function appendMessage(message, type) {
    // 获取消息容器元素
    const container = document.getElementById('messages-container');
    // 创建一个新的消息元素
    const messageElement = document.createElement('a');
    // 设置消息元素的文本内容
    messageElement.innerText = message;
    // 为消息元素添加通用的消息样式类和特定类型样式类
    messageElement.classList.add('message', type);
    // 将消息元素添加到消息容器中
    container.appendChild(messageElement);
    return messageElement;
}

</script>

</body>
</html>
